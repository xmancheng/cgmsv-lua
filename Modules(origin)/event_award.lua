-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
--ahsin做的：主线剧情任务进度查询奖励系统
--版本：20241124
--本lua必须运行在m佬的新框架下
--首发论坛 www.cnmlb.com 获取最新版本

--由于功能比较丰富，免费分享归免费过来b站点个赞、一键三连不过分吧？
--https://space.bilibili.com/21127109
--qq群：85199642

--本lua只支持cgmsv+新框架，不然100%跑不起来
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------

--模块类
local event_awardModule = ModuleBase:createModule('event_award')

--加载模块钩子
function event_awardModule:onLoad()
	self:logInfo('load')
	event_npc = self:NPC_createNormal('主∏楠',14586,{x=226,y=83,mapType=0,map=1000,direction=4})--endevent npc
	Char.SetData(event_npc,CONST.对象_ENEMY_PetFlg+2,0)--可穿透体
	self:NPC_regTalkedEvent(event_npc,Func.bind(self.face2npc,self))--面向npc触发
	self:NPC_regWindowTalkedEvent(event_npc,Func.bind(self.click,self))--npc窗口按钮触发
end

local on = '$5已完成$0'--可diy
local off = '$8未完成$0'--可diy
local nowpage = {}--玩家翻页记录表
--★★★感谢超爱大佬统计提供的endevent大全excel★★★
local end_events = {--主线剧情任务列表
--[1]endeventid[2]文字介绍[3]奖励介绍[4]奖励道具itemid（-1无奖励）[5]数量（无奖励时数字无效，随便填）
{0,'王的信','任拧10',70075,10},--示例，拿到王的信，1@，畹谰叱^1的M量可B加，否t後期判啾嘲空格容易出e
{1,'誓言的念珠','任拧2',70075,2},
{2,'新手','任拧1',70075,1},
{3,'希望的T-露比','任拧10',70075,10},
{5,'_⒄','任拧10',70075,10},
{6,'魔大-醉鬼','任拧2',70075,2},
{7,'少女的正x1',' ',-1,1},
{8,'少女的正x2',' ',-1,1},
{9,'少女的正x3',' ',-1,1},
{10,'少女的正x4',' ',-1,1},
{11,'少女的正x5',' ',-1,1},
{12,'少女的正x6',' ',-1,1},
{13,'少女的正x7',' ',-1,1},
{14,'少女的正x8',' ',-1,1},
{15,'少女的正x9',' ',-1,1},
{16,'少女的正x10',' ',-1,1},
{17,'探索zE的人',' ',-1,1},
{18,'冰雪的牢城-佛利波_','石×20',70076,20},
{19,'LQ之塔-阿卡斯','石×20',70076,20},
{21,'六曜之塔-李留斯','石×20',70076,20},
{22,'王m食堂-不合格N',' ',-1,1},--疑似可反徒尤。不建ho
{23,'王m食堂-敏腕N',' ',-1,1},
{24,'王m食堂-O上N',' ',-1,1},
{25,'王m食堂-究ON',' ',-1,1},
{26,'地下技-三冠王者','石×20',70076,10},
{28,'W亮之心','任拧5',70075,5},
{29,'光x的白y之魂','任拧5',70075,5},
{30,'迷路之穴',' ',-1,1},
{31,'仙人就1',' ',-1,1},
{32,'仙人就2',' ',-1,1},
{33,'仙人就3',' ',-1,1},
{34,'仙人就4',' ',-1,1},
{35,'再生花@1',' ',-1,1},--示例，o物的做成蛋
{36,'再生花@2',' ',-1,1},
{37,'再生花@3',' ',-1,1},
{38,'白城-引д','石×20',70076,20},
{39,'黑城-W耀者','石×20',70076,20},
{45,'崩落的坑道',' ',-1,1},
{46,'技龃竺m1',' ',-1,1},
{47,'技龃竺m2',' ',-1,1},
{48,'舞者就','Ａ◇艾薇(巫)',900206,1},
{50,'艾巴第八等渍','Ａ◇卡西W(兵)',900202,1},--可反徒尤。不建ho
{51,'艾巴第七等渍',' ',-1,1},
{52,'艾巴第六等渍',' ',-1,1},
{53,'艾巴第五等渍',' ',-1,1},
{54,'艾巴第四等渍',' ',-1,1},
{55,'艾巴第三等渍',' ',-1,1},
{56,'艾巴第二等渍',' ',-1,1},
{57,'艾巴第一等渍',' ',-1,1},
{58,'m第八等渍','Ａ◇卡西W(兵)',900202,1},
{59,'m第七等渍',' ',-1,1},
{60,'m第六等渍',' ',-1,1},
{61,'m第五等渍',' ',-1,1},
{62,'m第四等渍',' ',-1,1},
{63,'m第三等渍',' ',-1,1},
{64,'m第二等渍',' ',-1,1},
{65,'m第一等渍',' ',-1,1},
{66,'m-za',' ',-1,1},
{67,'商骄吐1','任拧1',70075,1},
{68,'商骄吐2','任拧1',70075,1},
{69,'商骄吐3','任拧1',70075,1},
{70,'商骄吐4','任拧1',70075,1},
{71,'商骄吐5','任拧1',70075,1},
{72,'商骄吐6','任拧1',70075,1},
{73,'商骄吐7','任拧1',70075,1},
{74,'商骄吐8','任拧1',70075,1},
{75,'商骄吐9','任拧1',70075,1},
{76,'盗贼就1','任拧5',70075,5},
{77,'盗贼就2','任拧10',70075,10},
{78,'{分布M度','任拧1',70075,1},
{79,'{分布M度','任拧1',70075,1},
{80,'{分布M度','任拧1',70075,1},
{81,'{分布M度','任拧1',70075,1},
{82,'{分布M度','任拧1',70075,1},
{83,'{分布M度','任拧1',70075,1},
{84,'{分布M度','任拧1',70075,1},
{85,'{分布M度','任拧1',70075,1},
{86,'{分布M度','任拧1',70075,1},
{87,'仙人就1','任拧5',70075,5},
{88,'仙人就2','任拧10',70075,10},
{89,'路霸阿德基姆','Ａ◇伊RW斯()',900203,1},
{90,'誓言之花-4D','石×10',70076,10},--可D，不建ho
{91,'{咒的迷m-3D','Ａ◇瑟菲(咒)',900205,1},
{92,'挑鹕瘾F-2D','Ａ◇S克_斯(法)',900204,1},
{93,'渚L老-1D','Ａ◇艾瑟利昂()',900200,1},
{94,'伊魉','任拧1',70075,1},
{95,'}拉卡魉','任拧1',70075,1},
{96,'留特魉','任拧1',70075,1},
{97,'SZ魉','任拧1',70075,1},
{98,'奇利魉','任拧1',70075,1},
{99,'加{魉','任拧1',70075,1},
{100,'苤Z瓦魉','任拧1',70075,1},
{101,'蒂娜魉','任拧1',70075,1},
{102,'阿巴尼斯魉','任拧1',70075,1},
{103,'哥拉定居',' ',-1,1},--定居可，不建ho
{104,'月亮俱凡-董事L','任拧500',70075,500},
{105,'森_f象','石×200',70076,200},
{106,'情人-鄢蕴鸬娜',' ',-1,1},
{107,'情人-鄢岳钡娜',' ',-1,1},
{108,'艾七等支','任拧50',70075,50},
{109,'m七等支','任拧50',70075,50},
{110,'坎那拉村魉','任拧5',70075,5},
{111,'m7其他M度',' ',-1,1},
{112,'m7其他M度',' ',-1,1},
{113,'m7其他M度',' ',-1,1},
{114,'m6其他M度',' ',-1,1},
{115,'m5其他M度',' ',-1,1},
{116,'m5其他M度',' ',-1,1},
{117,'m4其他M度',' ',-1,1},
{118,'m4其他M度',' ',-1,1},
{119,'mx其他M度',' ',-1,1},
{120,'mx其他M度',' ',-1,1},
{121,'mx其他M度',' ',-1,1},
{122,'mx其他M度',' ',-1,1},
{123,'mx其他M度',' ',-1,1},
{124,'mx其他M度',' ',-1,1},
{125,'月亮俱凡-[手好e的人','任拧10',70075,10},
{126,'浪漫主x者1',' ',-1,1},
{127,'浪漫主x者2',' ',-1,1},
{128,'m6其他M度',' ',-1,1},
{129,'m6其他M度',' ',-1,1},
{130,'帕P斯的亡`','任拧10',70075,10},
{131,'帕P斯的亡`-魔鬼w星','石×20',70076,20},
{132,'之拯救者-[','任拧10',70075,10},
{133,'之拯救者','任拧10',70075,10},
{134,'之拯救者-w途白yT士','石×20',70076,20},
{135,'米Z基魉','任拧10',70075,10},
{136,'五等追加','任拧20',70075,20},
{137,'盲目之艾汀-北行者','石×10',70076,10},
{138,'白y之T士豪-北行者','石×10',70076,10},
{139,'盲目之艾汀-北行者','石×20',70076,20},
{140,'格梅特之魂-G-解放者','石×5',70076,5},
{141,'之沙漏-t-解放者','石×5',70076,5},
{142,'之沙漏-{-解放者','石×5',70076,5},
{143,'格梅特之魂-解放者','石×5',70076,5},
{144,'1000f在o念-法m城市民',' ',-1,1},
{145,'m三追加','任拧20',70075,20},
{146,'m三追加','任拧20',70075,20},
{147,'m二追加','任拧20',70075,20},
{150,'地z祭-迷m冒U野郎',' ',-1,1},
{152,'天界T士','石×5',70076,5},
{153,'星歌姬','石×5',70076,5},
{154,'追ど竦o回的人',' ',-1,1},
{155,'h米D村魉','任拧20',70075,20},
{156,'魔弓髌1','任拧10',70075,10},
{157,'魔弓髌2','任拧20',70075,20},
{159,'砂之解放者',' ',-1,1},
{160,'光之冒U者',' ',-1,1},
{161,'hL之m-o魉','任拧10',70075,10},
{162,'醉鬼中的霸主',' ',-1,1},
{163,'秘密M的邀',' ',-1,1},
{164,'四}F回',' ',-1,1},
{165,'十周年的感',' ',-1,1},
{166,'公主髡f-秋鞯谖渍',' ',-1,1},
{167,'公主髡f-春训谖渍',' ',-1,1},
{168,'公主髡f-秋鞯谒渍',' ',-1,1},
{169,'公主髡f-春训谒渍',' ',-1,1},
{170,'公主髡f-秋鞯谌渍',' ',-1,1},
{171,'公主髡f-春训谌渍',' ',-1,1},
{172,'公主髡f-秋鞯诙渍',' ',-1,1},
{173,'公主髡f-春训诙渍',' ',-1,1},
{174,'公主髡f-秋鞯谝渍',' ',-1,1},
{175,'公主髡f-春训谝渍',' ',-1,1},
{176,'}B之i',' ',-1,1},
{177,'H罪的亡`章',' ',-1,1},
{178,'小u之i',' ',-1,1},
{179,'地z的回',' ',-1,1},
{180,'死神的降R',' ',-1,1},
{181,'死c新生',' ',-1,1},
{200,'魔界L水',' ',-1,1},
{202,'上流社人士',' ',-1,1},
{202,'不屈不系',' ',-1,1},
{203,'B者',' ',-1,1},
{204,'B鹬王',' ',-1,1},
{205,'勇獾拇B',' ',-1,1},
{206,'托丘的-接|者','石×5',70076,5},
{207,'的接|者-天界的改革者','石×15',70076,15},
{208,'小u阿哲-守o者',' ',-1,1},
{209,'英勇鹗',' ',-1,1},
{210,'被Z走的品',' ',-1,1},
{212,'泰格利的',' ',-1,1},
{213,'蒂娜沈船zE',' ',-1,1},
{241,'尼S海村魉','任拧10',70075,10},
{242,'克瑞村魉','任拧10',70075,10},
{243,'摩D村魉','任拧10',70075,10},
{244,'雷W娜村魉','任拧10',70075,10},
--以此类推
}

function event_awardModule:face2npc(npc,player)--面向npc触发
	nowpage[player] = 0
	show_window(npc,player)
	return 0
end

function event_awardModule:click(npc,player,seq,sel,data)--窗口中点击触发
	--print('seq：' .. seq)
	--print('sel：' .. sel)
	--print('data：' .. data)
	data = tonumber(data)
	if seq == 0 then
		if sel == 32 then--下一页
			nowpage[player] = nowpage[player] + 1
			show_window(npc,player)
		elseif sel == 16 then--上一页
			nowpage[player] = nowpage[player] - 1
			show_window(npc,player)
		elseif sel == 1 then--领奖
			giveitem(player)--给奖励
			--NLG.ShowWindowTalked(player,npc,CONST.窗口_信息框,1,1,'@c\\n\\n\\n\\n制作中，尽请期待...')
		end
	end
	if seq == 444 and sel == 16 then--错误页返回
		nowpage[player] = 0
		show_window(npc,player)
	end
end

function show_window(npc,player)--弹窗
	--[1]endeventid[2]文字介绍[3]奖励介绍[4]奖励道具itemid（-1无奖励）[5]数量（无奖励时数字无效，随便填）
	local maxpage = math.ceil(#end_events/20)
	local neirong = '                      【主∏ - 查】\\n'
	neirong = neirong .. '                            $4< ' .. nowpage[player]+1 .. '/' .. maxpage .. ' >$0\\n'
	for i = 1,20 do
		i = i + nowpage[player]*20
		if i > #end_events then
			break
		end
		neirong = neirong --[[.. i .. '.']] .. left(end_events[i][2],28) .. left('$1' .. end_events[i][3] .. '$0',21)
		.. isend(player,end_events[i][1]) .. '  ' ..isawarded(player,i) .. '\\n'
	end
	if nowpage[player] == 0 then--第一页
		neirong = neirong .. '            $2$0 c簟$4_ 定$0】 I取'
		NLG.ShowWindowTalked(player,npc,CONST.窗口_巨信息框,35,0,neirong)
	elseif nowpage[player] == maxpage-1 then--最后一页
		local less = 20 - (#end_events - ((maxpage-1)*20))--剩余行数匹配
		--print('maxpage：'..maxpage..'，#end_events：'..#end_events..'，剩余行计算：'..less)
		for i = 1,less do
			neirong = neirong .. '\\n'
		end
		neirong = neirong .. '            $2$0 c簟$4_ 定$0】 I取'
		NLG.ShowWindowTalked(player,npc,CONST.窗口_巨信息框,19,0,neirong)
	else--中间页
		neirong = neirong .. '         $2$0 c簟$4_ 定$0】 I取'
		NLG.ShowWindowTalked(player,npc,CONST.窗口_巨信息框,51,0,neirong)
	end
end

function isend(player,endeventid)--检查主线状态
	if Char.EndEvent(player,endeventid) == 1 then
		return on
	else
		return off
	end
end

function isawarded(player,i)--是否可领取奖励
	if end_events[i][4] >= 0 then--有设置奖励
		if Char.GetExtData(player,'endevent'..end_events[i][1]) == 1 then--0=未领取，1=已领取
			return '$1已I取$0'
		else
			if Char.EndEvent(player,end_events[i][1]) == 1 then
				return '$4未I取$0'
			elseif Char.EndEvent(player,end_events[i][1]) == 0 then
				return '$8不可I$0'
			end
		end
	else--没设置奖励
		return '$7o品$0'
	end
end

function giveitem(player)--给奖励
--[1]endeventid[2]文字介绍[3]奖励介绍[4]奖励道具itemid（-1无奖励）[5]数量（无奖励时数字无效，随便填）
local count = 0
	for i = 1,#end_events do
		--print('i = '..i..'，'..tostring('endevent'..end_events[i][1])..' = '..Char.EndEvent(player,end_events[i][1]))
		if Char.GetExtData(player,tostring('endevent'..end_events[i][1])) ~= 1 and Char.EndEvent(player,end_events[i][1]) == 1 then--0=未领取，1=已领取
			if end_events[i][4] > -1 then--判断是否给道具
				if Char.ItemSlot(player)+8 >= Char.GetData(player,CONST.CHAR_道具栏) then--道具满了
					NLG.ShowWindowTalked(player,event_npc,CONST.窗口_信息框,18,444,'@c\\n\\n\\n\\n你的|西太多了。')
					Char.SaveToDb(player)
					return
				else
					Char.SetExtData(player,tostring('endevent'..end_events[i][1]),1)--标记为已领取
					Char.GiveItem(player,end_events[i][4],end_events[i][5])--给道具
					count = count + 1
				end
			end
		end
	end
	if count == 0 then
		NLG.ShowWindowTalked(player,event_npc,CONST.窗口_信息框,18,444,'@c\\n\\n\\n\\你]有可I取的睢')
	end
	Char.SaveToDb(player)
end

function left(str,len)--居左
    local char = ' ' -- 填充空格
	if len-#str >= 0 then
		local padding = string.rep(char,len-#str)
		return str..padding
	else
		local text = '$4<太长请修改>$0'
		local padding = string.rep(char,len-#text)
		return text..padding
	end
end

--卸载模块钩子
function event_awardModule:onUnload()
	self:logInfo('unload')
end

return event_awardModule

